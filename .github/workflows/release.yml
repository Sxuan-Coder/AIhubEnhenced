name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - "v*.*.*" # åŒ¹é… v1.0.0, v0.1.0 ç­‰ç‰ˆæœ¬æ ‡ç­¾

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆæ›´æ–°æ—¥å¿—

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ª tagï¼Œè·å–æ‰€æœ‰æäº¤
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # è½¬ä¹‰æ¢è¡Œç¬¦å¹¶ä¿å­˜åˆ°è¾“å‡º
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

          # è¾“å‡ºé¢„è§ˆ
          echo "## æ›´æ–°å†…å®¹"
          git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges || git log --pretty=format:"- %s (%h)" --no-merges

      - name: æ‰“åŒ…æ‰©å±• (Extension ZIP)
        run: |
          # è¿›å…¥ extension ç›®å½•æ‰“åŒ…ï¼Œç¡®ä¿ ZIP æ ¹ç›®å½•ç›´æ¥åŒ…å«æ‰©å±•æ–‡ä»¶
          cd extension
          zip -r ../AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip \
            manifest.json \
            content.js \
            styles.css \
            jszip.min.js \
            icons/
          cd ..
          echo "æ‰“åŒ…å®Œæˆ: AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip"
          ls -lh AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip
          
          # éªŒè¯ ZIP å†…å®¹
          echo "éªŒè¯ ZIP ç»“æ„:"
          unzip -l AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip | head -20

      - name: æ‰“åŒ…æºä»£ç  (Source ZIP)
        run: |
          zip -r AIhubEnhenced-source-${{ steps.get_version.outputs.version }}.zip \
            extension/ \
            scripts/ \
            openspec/ \
            README.md \
            AGENTS.md \
            -x "*.git*" -x "*node_modules*" -x "*.DS_Store"
          echo "æºä»£ç æ‰“åŒ…å®Œæˆ: AIhubEnhenced-source-${{ steps.get_version.outputs.version }}.zip"
          ls -lh AIhubEnhenced-source-${{ steps.get_version.outputs.version }}.zip

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: AIhubEnhenced ${{ steps.get_version.outputs.version }}
          body: |
            # AIhubEnhenced ${{ steps.get_version.outputs.version }}

            ## æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.changelog }}

            ## å®‰è£…æ–¹æ³•

            ### æ–¹æ³•ä¸€ï¼šç›´æ¥åŠ è½½è§£å‹æ–‡ä»¶ï¼ˆæ¨èï¼‰

            1. ä¸‹è½½ `AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip`
            2. **è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹**
            3. æ‰“å¼€æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢
               - Chrome: `chrome://extensions/`
               - Edge: `edge://extensions/`
            4. å¯ç”¨å³ä¸Šè§’çš„ **"å¼€å‘è€…æ¨¡å¼"**
            5. ç‚¹å‡» **"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"**
            6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹ï¼ˆåŒ…å« manifest.json çš„æ–‡ä»¶å¤¹ï¼‰
            
            ### æ–¹æ³•äºŒï¼šç›´æ¥æ‹–æ”¾ ZIPï¼ˆéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰
            
            1. ä¸‹è½½ `AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip`
            2. æ‰“å¼€æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢å¹¶å¯ç”¨å¼€å‘è€…æ¨¡å¼
            3. ç›´æ¥å°† ZIP æ–‡ä»¶æ‹–æ”¾åˆ°æ‰©å±•é¡µé¢

            ## æ”¯æŒçš„å¹³å°

            - âœ… Gemini (gemini.google.com)
            - âœ… ChatGPT (chatgpt.com / chat.openai.com)
            - âœ… Grok (grok.x.ai / grok.com / x.com/i/grok)

            ## æ–‡ä»¶è¯´æ˜

            - `AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip` - æµè§ˆå™¨æ‰©å±•åŒ…ï¼ˆæ¨èä¸‹è½½ï¼Œè§£å‹åå¯ç›´æ¥åŠ è½½ï¼‰
            - `AIhubEnhenced-source-${{ steps.get_version.outputs.version }}.zip` - å®Œæ•´æºä»£ç ï¼ˆåŒ…å«æ‰€æœ‰é¡¹ç›®æ–‡ä»¶ï¼‰
            - `Source code (zip/tar.gz)` - GitHub è‡ªåŠ¨ç”Ÿæˆçš„æºä»£ç 
          files: |
            AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip
            AIhubEnhenced-source-${{ steps.get_version.outputs.version }}.zip
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ Release ${{ steps.get_version.outputs.version }} å·²æˆåŠŸå‘å¸ƒï¼"
          echo "ğŸ“¦ æ‰©å±•åŒ…: AIhubEnhenced-${{ steps.get_version.outputs.version }}.zip"
          echo "ğŸ“„ æºä»£ç : AIhubEnhenced-source-${{ steps.get_version.outputs.version }}.zip"
          echo "ğŸ”— è®¿é—®: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"
